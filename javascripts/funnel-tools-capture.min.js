/*!
 * Funnel Tools Capture Library v1.1.0
 * http://brandonhilkert.com/funnel-tools/capture
 *
 * Copyright 2015 Big Blue Media, LLC
 * http://brandonhilkert.com
 *
 * Date: 2015-02-20T13:58Z
 */

window.FunnelTools || (window.FunnelTools = {});
FunnelTools.Capture = {
  titleHeight: 45,
  showTime: 22000,

  init: function(opts){
    if (opts && opts.showTime) {
      this.showTime = opts.showTime;
    }

    this.widget().css('bottom', '-' + this.position() + "px");
    this.triggerShow(this.showTime);
  },
  widget: function() {
    return $("#funnel-tools-capture");
  },
  open: function() {
    return $("#funnel-tools-capture .open");
  },

  close: function() {
    return $("#funnel-tools-capture .close");
  },
  show: function(){
    this.widget().animate({ bottom: 0 }, 200);
    this.widget().addClass('open');
    this.open().fadeOut();
    this.close().fadeIn();
  },
  triggerShow: function(time) {
    var that = this;

    setTimeout(function() {
      that.show();
    }, time);
  },
  hide: function(){
    this.widget().animate({ bottom: '-' + this.position() + 'px' }, 200);
    this.widget().removeClass('open');
    this.close().fadeOut();
    this.open().fadeIn();
  },
  toggle: function(){
    if (!this.widget().hasClass('open')) {
      this.show();
    }
    else {
      this.hide();
    }
  },
  position: function() {
    return this.height() - this.titleHeight;
  },
  height: function() {
    return this.widget()[0].scrollHeight;
  }
}

$(document).on("click", "#funnel-tools-capture .title, #funnel-tools-capture .open, #funnel-tools-capture .close", function(){
  FunnelTools.Capture.toggle();
});

$(document).ready(function(){
  FunnelTools.Capture.init();
  $("#funnel-tools-capture form").submit(function(event){
    var $form = $(event.target);
    var $title = $("#funnel-tools-capture .title");
    var $description = $("#funnel-tools-capture .description");
    var $email = $("#funnel-tools-capture input[type=email]");
    $.ajax({
      url: $form.attr('action'),
      method: 'POST',
      data: $form.serialize()
    }).done(function (data, textStatus, xhr) {
      if (xhr.status == 201) {
        $title.html('Thanks for signing up!');
        $description.html('Please check your email to confirm your subscription.');
      }
      else {
        console.log('Unknown issue: ', data, xhr);
      }
    }).fail(function (xhr, textStatus, error) {
      console.log('fail', xhr, textStatus, error);
      if (xhr.status == 401) {
        console.log('Email already signed up');
        $description.html("You've already signed up with that email.  You can <a href=\"https://www.pythonmorsels.com/accounts/login/\">login here</a>.")
      }
      else if (xhr.status == 400) {
        console.log('Invalid email');
        $email.next('span.error').remove();
        $email.after('<span class="error">Email invalid</span>');
        $email.addClass('error');
      }
      else {
        console.log('Unknown issue: ', error, textStatus, xhr);
        alert("An unexpected error occurred while submitting this form.  Sorry!  Please feel free to contact Trey to troubleshoot.");
      }
    });
    event.preventDefault();
  });
  $("#funnel-tools-capture input[type=email]").focus(function(event) {
    var $email = $(event.target);
    $email.removeClass('error')
    $email.next('span.error').remove();
  });
});
